# アーキテクチャドキュメント

## システム構成図

```
┌─────────────────────────────────────────────────────────────────┐
│                          GitHub Repository                        │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                   Pull Request Created                     │   │
│  └────────────────────┬─────────────────────────────────────┘   │
└───────────────────────┼──────────────────────────────────────────┘
                        │
                        ▼
┌───────────────────────────────────────────────────────────────────┐
│                       GitHub Actions                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐   │
│  │ Docker Build │→ │ Push to ECR  │→ │ Terraform Apply      │   │
│  └──────────────┘  └──────────────┘  └──────────────────────┘   │
└───────────────────────┬───────────────────────────────────────────┘
                        │
                        ▼
┌───────────────────────────────────────────────────────────────────┐
│                            AWS Cloud                                │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │                  Shared Infrastructure                        │  │
│  │                                                               │  │
│  │  ┌──────────────┐    ┌─────────────────┐    ┌───────────┐  │  │
│  │  │   VPC        │    │  ECS Cluster    │    │    ECR    │  │  │
│  │  │  (10.0.0.0/16)│    │  (Fargate)      │    │           │  │  │
│  │  └──────────────┘    └─────────────────┘    └───────────┘  │  │
│  │                                                               │  │
│  │  ┌──────────────────────────────────────────────────────┐   │  │
│  │  │  Application Load Balancer (Shared)                  │   │  │
│  │  │  *.preview.example.com                               │   │  │
│  │  └──────────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │                  PR Environment (per PR)                      │  │
│  │                                                               │  │
│  │  PR #123                                                      │  │
│  │  ┌──────────────────────────────────────────────────┐        │  │
│  │  │  Route53: pr-123.preview.example.com             │        │  │
│  │  └────────────────────┬─────────────────────────────┘        │  │
│  │                       │                                       │  │
│  │                       ▼                                       │  │
│  │  ┌──────────────────────────────────────────────────┐        │  │
│  │  │  ALB Target Group + Listener Rule                │        │  │
│  │  │  Host: pr-123.preview.example.com                │        │  │
│  │  └────────────────────┬─────────────────────────────┘        │  │
│  │                       │                                       │  │
│  │                       ▼                                       │  │
│  │  ┌──────────────────────────────────────────────────┐        │  │
│  │  │  ECS Service (Fargate)                           │        │  │
│  │  │  - Task Definition                               │        │  │
│  │  │  - Container: app:pr-123                         │        │  │
│  │  │  - CPU: 256, Memory: 512MB                       │        │  │
│  │  └──────────────────────────────────────────────────┘        │  │
│  │                                                               │  │
│  │  ┌──────────────────────────────────────────────────┐        │  │
│  │  │  CloudWatch Logs                                 │        │  │
│  │  │  /ecs/pr-123/app                                 │        │  │
│  │  └──────────────────────────────────────────────────┘        │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## コンポーネント詳細

### 1. 共有インフラストラクチャ

#### VPC
- CIDR: 10.0.0.0/16
- パブリックサブネット x2 (AZ分散)
- プライベートサブネット x2 (AZ分散)
- NAT Gateway x2 (高可用性)
- Internet Gateway

#### Application Load Balancer
- インターネット向け
- HTTPSリスナー (443)
- HTTPリスナー (80) → HTTPSリダイレクト
- ACM証明書: *.preview.example.com
- セキュリティグループ: 80/443許可

#### ECS Cluster
- Fargate起動タイプ
- Container Insights有効
- Fargate + Fargate Spot対応

#### ECR
- プライベートリポジトリ
- イメージスキャン有効
- ライフサイクルポリシー: 最新10個のPRイメージを保持

### 2. PR環境（PRごとに作成）

#### Route53レコード
- Aレコード (Alias)
- 命名規則: pr-{PR番号}.preview.example.com
- ALBを参照

#### ALBリソース
- ターゲットグループ (IPターゲット)
- リスナールール (ホストベースルーティング)
- 優先度: PR番号 + 1000

#### ECS リソース
- サービス: pr-{PR番号}-app
- タスク定義
  - コンテナポート: 3000
  - CPU: 256
  - メモリ: 512MB
  - ヘルスチェック: /health
- セキュリティグループ
  - インバウンド: ALBからのみ許可
  - アウトバウンド: 全て許可

#### IAMロール
- タスク実行ロール
  - ECRからイメージプル
  - CloudWatch Logsへ出力
- タスクロール
  - アプリケーションが必要とする権限

#### CloudWatch Logs
- ロググループ: /ecs/pr-{PR番号}/app
- 保持期間: 7日

## データフロー

### 1. リクエストフロー（ユーザー → アプリケーション）

```
Internet
    │
    ▼
Route53 (pr-123.preview.example.com)
    │
    ▼
ALB (HTTPS:443)
    │
    ▼
ALB Listener Rule (Host: pr-123.preview.example.com)
    │
    ▼
Target Group
    │
    ▼
ECS Task (Private Subnet)
    │
    ▼
Container (Port 3000)
```

### 2. デプロイフロー

```
GitHub PR Event
    │
    ▼
GitHub Actions Trigger
    │
    ├─► Docker Build
    │   └─► ECR Push (tag: pr-{PR番号})
    │
    └─► Terraform
        ├─► terraform init (S3 backend)
        ├─► terraform plan
        └─► terraform apply
            ├─► Route53 Record
            ├─► Target Group
            ├─► Listener Rule
            ├─► Task Definition
            └─► ECS Service
```

### 3. ログフロー

```
Container stdout/stderr
    │
    ▼
CloudWatch Logs Agent (awslogs driver)
    │
    ▼
CloudWatch Logs Group (/ecs/pr-{PR番号}/app)
    │
    ▼
[オプション] Log Insights, Metrics, Alarms
```

## セキュリティ

### ネットワーク層
- プライベートサブネットでアプリケーション実行
- ALBがインターネットとの境界
- セキュリティグループで最小権限

### アプリケーション層
- 非rootユーザーでコンテナ実行
- イメージスキャンで脆弱性検出
- 環境変数で機密情報管理（Secrets Manager連携可能）

### アクセス制御層
- IAMロールで最小権限
- GitHub OIDC連携で認証情報不要
- S3バケット暗号化

## スケーラビリティ

### 水平スケーリング
- ECS Service Auto Scaling
  - CPU/メモリベース
  - リクエスト数ベース

### コスト最適化
- Fargate Spot使用で最大70%削減
- タスク数の自動調整
- アイドル環境の自動削除

## 監視とアラート

### メトリクス
- ECS: CPU/メモリ使用率、タスク数
- ALB: リクエスト数、レスポンスタイム、エラー率
- CloudWatch: カスタムメトリクス

### ログ
- アプリケーションログ
- ECSイベントログ
- ALBアクセスログ（オプション）

### アラート
- タスク異常終了
- 高CPU/メモリ使用率
- ヘルスチェック失敗

## ディザスタリカバリ

### バックアップ
- Terraformステート: S3 (バージョニング有効)
- コンテナイメージ: ECR (ライフサイクル管理)

### リカバリ手順
1. Terraformステートからの復旧
2. ECRイメージからのデプロイ
3. DNS切り替え（Route53）

## 制限事項

### AWS制限
- ECSタスク起動制限
- ALBリスナールール上限（デフォルト100）
- Route53クエリ制限

### 設計上の制限
- PR番号は数値のみ
- 同時稼働PR環境推奨数: ~20個
- 1PR環境あたりタスク数: 1-2個推奨

## 今後の拡張案

1. **データベース統合**
   - RDS Proxyの共有
   - Auroraサーバーレスv2

2. **キャッシュ層**
   - ElastiCache Redis共有

3. **CI/CD強化**
   - E2Eテスト自動実行
   - パフォーマンステスト

4. **コスト最適化**
   - Savings Plans適用
   - Spot Instance活用

5. **セキュリティ強化**
   - WAF統合
   - GuardDuty連携
